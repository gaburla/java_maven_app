pipeline {
    agent any

    tools {
        maven "test-mav"
    }

    environment {
        registry = "319952980369.dkr.ecr.us-east-2.amazonaws.com"
        awsRegion = "us-east-2"
        ecrRepository = "lesson4test"
    }

    stages {
        stage('Pull Code from GitHub') {
            steps {
                script {
                    git branch: 'master',
                        credentialsId: 'gaburla_git_key',
                        url: 'git@github.com:gaburla/java_maven_app.git'
                }
            }
        }
        stage('Package and Test Code') {
            steps {
                sh "mvn test"
                sh "mvn package"
            }
        }
        stage('Copy image') {
            steps {
                sh '''
                    lm="$HOME/shared/$BUILD_NUMBER"
                    mkdir "$lm"
                    echo "$lm created"

                    cp -rf ./target/java-maven-app-*.jar "$lm/"
                    echo "copied"
                '''
            }
        }
        stage('Build image') {
            steps {
                sh '''
                    docker build -t ${env.ecrRepository}:${BUILD_ID} .
                '''
            }
        }
        stage('Build and Push to AWS ECR') {
            steps {
                script {
                    // AWS ECR login
                    sh "aws ecr get-login-password --region ${env.awsRegion} | docker login --username AWS --password-stdin ${env.registry}"

                    // Docker tag
                    sh "docker tag ${env.ecrRepository}:${BUILD_ID} ${env.registry}/${env.ecrRepository}:${BUILD_ID}"

                    // Docker push
                    sh "docker push ${env.registry}/${env.ecrRepository}:${BUILD_ID}"
                }
            }
        }
    }
}
